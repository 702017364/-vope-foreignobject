const e=/^data:image/i,t=/^(data:image\/svg\+xml,)(?:\<|\%3C)svg/i,n=/^-(?:ms|webkit|moz)-/g,o={woff2:!0,woff:!0,svg:/Opera|OPR|Chrome|Safari/i.test(navigator.userAgent),truetype:!0},r=e=>{const t=Object.create({});return e.forEach(e=>{if(Array.isArray(e)){const n=e[0];e[1].forEach(e=>t[`${n}-${e}`]=!0)}else t[e]=!0}),t},s=(e="a")=>{return e+Math.random().toString().replace(".","")},a=(e,t)=>{const n=new Promise(t);return e.push(n),n},c=(e,t)=>{const n=document.createElement("a");n.download=e,n.href=t;const o=document.createEvent("MouseEvents");o.initEvent("click"),n.dispatchEvent(o)},i=({src:e,width:t,height:n,load:o})=>{const r=new Image;return void 0===t||(r.width=t),void 0===n||(r.width=n),"function"==typeof o&&(r.onload=(()=>o(r))),r.src=e instanceof HTMLCanvasElement?e.toDataURL("image/png",1):e,r},l=(e,t,n,o)=>{const r=document.createElement("style");r.textContent=`@font-face{\n    font-family: '${e.family}';\n    src: url(${t}) format('${n}');\n    font-stretch: ${e.stretch};\n    font-style: ${e.style};\n    font-weight: ${e.weight};\n    unicode-range: ${e.unicodeRange};\n  }`,o.appendChild(r)},h=/^:{0,2}([^:]+)$/,d=(e,t)=>{let n;if(e instanceof HTMLElement){const o=t.match(h);if(!o)return!1;t=`::${o[1]}`,n=getComputedStyle(e,t)}else n=e;const o=n.getPropertyValue("content");return!["none","normal"].includes(o)&&"none"!=n.getPropertyValue("dispaly")},u=e=>{return`data:image/svg+xml;base64,${btoa(decodeURIComponent(e))}`},m=e=>new Promise((t,n)=>{fetch(e).then(e=>{if(200==e.status)return e.blob();throw new Error(e.statusText)},e=>{throw e}).then(e=>{const n=new FileReader;n.readAsDataURL(e),n.onload=t}).catch(n)}),f=/^(?:https?|ftp)/i,g=/^\//,p=/^(?:https?|ftp):\/\/[\w.]+(?:\:\d+)?/gi,w=/[\?#]/,y=(e,t)=>{if(f.test(e))return e;if(g.test(e)){return t.match(p)[0]+e}return t.split(w)[0]+e},E=r([["min",["width","height"]],["max",["width","height"]],["transition",["property","duration","timing-function","delay"]],["animation",["name","duration","timing-function","delay","iteration-count","direction","play-state","fill-mode"]],"cursor","ime-mode","pointer-events"]),v=r(["background-image","content","border-image-source","list-style-image","clip-path","filter","mask-box-image","-webkit-mask-image","mask-image","mask-box-image"]),b=(()=>{const e=window.getComputedStyle(document.documentElement),t=new Set(e);return["counter-increment","counter-reset","content"].forEach(e=>t.add(e)),Array.from(t)})();const C=/url\(/,$=/(none|[a-z-]+\((?:[^\(\)]|\([^\(\)]+\))+\))(?:,\s)?/g;const x=/url\("([^\(\)]+?)"\)(?:\sformat\("([a-z]+?)"\))?/g,k=/\.\w+?$/;export default(r,h)=>{return new class{constructor(e,t={}){const n=window.getComputedStyle(e).getPropertyValue("display");if(!n)throw new Error("截图元素必需加入文档");if("none"==n)throw new Error('截图元素（CSS）display 属性值不能为 "none"');this.element=e,this.option=Object.assign({clearPlaceholder:!1,download:!1,downloadName:null,downloadType:"png",ignoreFetchError:!0},t),this.fecthCaches={}}async drawCanvas(){const{element:e,option:t}=this;this.caches={};const n=this.queues=[];this.addFonts=await this.collectFonts();const o=this.clone=this.deepCloneElement(e);return this.loadFonts(o),new Promise(d=>Promise.all(n).then(()=>{r=o,a=e.offsetWidth,l=e.offsetHeight,h=(e=>{if(t.download){const n=t.downloadName||s(),o=t.downloadType||"png",r=n+o,a=e.toDataURL(o);c(r,a)}t.test&&(e.cloneElement=o),d(e)}),new Promise(e=>{if(r){const t=encodeURIComponent((new XMLSerializer).serializeToString(r));i({width:a,height:l,src:`data:image/svg+xml;charset=utf-8,\n        <svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="${l}">\n          <foreignObject width="100%" height="100%" x="0" y="0">${t}</foreignObject>\n        </svg>`,load:e})}else e()}).then(e=>{const t=document.createElement("canvas");t.width=a||10,t.height=l||10;const n=t.getContext("2d");e&&n.drawImage(e,0,0),h(t)})}));var r,a,l,h}loadFonts(){const{ownerDocument:e}=this.element,t=function(e,t,n){const r=e.length,s={};if(!r)return s;const a={};e.forEach(e=>a[e.family]=e);const c=(e,t)=>{const n=t.lastIndexOf("/"),o=k.test(t)?t.slice(0,n+1):t;return y(e,o)};let i=0;return[].some.call(t,({cssRules:e,href:t=n})=>[].some.call(e,({type:e,style:n})=>{if(!n)return;const l=n.getPropertyValue("font-family");if(5!=e||l in a^1)return;const h=n.getPropertyValue("src");let d;for(;null!=(d=x.exec(h));){const e=d[2];if(e&&o[e]){s[l]={fontface:a[l],src:c(d[1],t),type:e},i++,x.lastIndex=0;break}}return i>=r||void 0})),s}(this.fonts,e.styleSheets,e.location.href);for(let e in t){const{fontface:n,src:o,type:r}=t[e];a(this.queues,e=>{m(o).then(t=>{l(n,t.target.result,r,this.clone),e()}).catch(()=>{if(!this.option.ignoreFetchError)throw new Error(`加载服务器字体 ${o} 错误`);e()})})}}async collectFonts(){const e=await async function(e){const t={},n=[],o=e=>t[e.family]=e;e.forEach(e=>{switch(e.status){case"loaded":o(e);break;case"loading":a(n,t=>e.loaded.then(t,t))}}),await Promise.all(n).then(e=>e.forEach(o));const r={};return e=>{const o=[];return e.split(",").forEach(e=>{const s=e.trim(),a=t[s];a&&s in n^1&&(r[s]=!0,o.push(a))}),o}}(this.element.ownerDocument.fonts),t=this.fonts=[];return n=>[].push.apply(t,e(n))}deepCloneElement(e){if("none"===window.getComputedStyle(e).getPropertyValue("display"))return;const t=this.cloneNode(e);if(!t)return;const n=e.tagName.toLocaleLowerCase();return["textarea"].includes(n)||[].forEach.call(e.childNodes,e=>{let n;switch(e.nodeType){case 1:n=this.deepCloneElement(e);break;case 3:n=e.cloneNode()}n&&t.appendChild(n)}),this.clonePseudoElements(e,t),t}cloneNode(n){const{clearPlaceholder:o}=this.option;let r,s=n.cloneNode();e:switch(n.tagName.toLocaleLowerCase()){case"input":switch(n.type){case"image":break;case"color":throw new Error('不支持 input[type="color"] 元素截图');case"checkbox":case"radio":const e=n.checked;e&&s.setAttribute("checked",e);break e;case"button":case"reset":case"submit":case"file":break e;default:o&&s.removeAttribute("placeholder"),s.setAttribute("value",n.value);break e}case"img":if(r=n.currentSrc||n.src,e.test(r)){const e=r.match(t);e&&(s.src=u(r.slice(e[1].length)))}else s.removeAttribute("src"),this.getImageBase64(r).then(e=>e&&(s.src=e));break;case"video":s.crossOrigin="Anonymous",s.src=n.currentSrc,s.currentTime=n.currentTime,s.autoplay=!1,s.loop=!1,a(this.queues,e=>{const t=()=>{s.removeEventListener("canplay",t,!1);const o=document.createElement("canvas"),r=o.width=n.videoWidth,a=o.height=n.videoHeight;o.getContext("2d").drawImage(s,0,0);const c=i({src:o,width:r,height:a});c.style.cssText=s.style.cssText,s.parentNode.replaceChild(c,s),e()};s.addEventListener("canplay",t,!1),s.onerror=(()=>{if(!this.option.ignoreFetchError)throw new Error(`加载视频 ${n.currentSrc} 错误`);e()})});break;case"canvas":s=i({width:n.width,height:n.height,src:n});break;case"iframe":s.removeAttribute("src");break;case"textarea":o&&s.removeAttribute("placeholder"),s.textContent=n.value}return s.style.cssText=this.cloneStyle(n,(e,t)=>s.style[e]=t),s}clonePseudoElements(e,t){const n=[];if(["before","after"].forEach(t=>d(e,t)&&n.push(t)),!n.length)return;const o=s("p");t.classList.add(o);const r=document.createElement("style"),a=[];n.forEach(n=>{const r=this.cloneStyle(e,(e,r)=>{const s=document.createElement("style");s.textContent=`.${o}::${n}{${e}: ${r};}`,t.appendChild(s)},`::${n}`);a.push(`.${o}::${n}{${r}}`)}),r.textContent=a.join(""),t.appendChild(r)}cloneStyle(o,r,s=null){const c=window.getComputedStyle(o,s),i=[];return b.forEach(o=>{const s=o.match(n),l=s?o.slice(s[0].length):o;if(l in E)return;const h=c.getPropertyValue(o);if(l in v&&"none"!==h&&C.test(h)){const n=function(n){const o=[];let r;const s=(e,t)=>{const n=t[1].length,o=e.slice(n);return`url(${u(o)})`};for(;null!=(r=$.exec(n));){let n=r[1];if("url"==n.slice(0,3)){const r=n.slice(5,-2);if(!e.test(r)){const e=this.getImageBase64(r);o.push(new Promise(t=>{e.then(e=>e?t(`url(${e})`):"none")}));continue}const a=r.match(t);a&&(n=s(r,a))}o.push(n)}return o}.call(this,h);if(n)return void a(this.queues,e=>Promise.all(n).then(t=>{r(o,t.join(",")),e()}))}else"font-family"==o&&this.addFonts(h);i.push(`${o}: ${h}`)}),i.join(";")}getImageBase64(e){const{fecthCaches:t}=this,n=t[e];if(n)return n;const o=new Promise(t=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=(()=>{const e=document.createElement("canvas"),o=e.getContext("2d");e.width=n.width,e.height=n.height,o.drawImage(n,0,0);const r=e.toDataURL("image/png",1);t(r)}),n.onerror=(()=>{if(!this.option.ignoreFetchError)throw new Error(`加载图片 ${e} 错误`);t()}),n.src=e});return this.queues.push(o),t[e]=o,o}}(r,h).drawCanvas()};